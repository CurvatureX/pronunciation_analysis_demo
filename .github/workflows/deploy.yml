name: Deploy to EC2

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint

  deploy:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.5.0

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_KEY }}
          aws-region: us-west-1

      - name: Generate SSH key pair
        run: |
          echo "ğŸ”‘ Generating SSH key pair..."
          ssh-keygen -t rsa -b 4096 -f ~/.ssh/pronunciation-analysis-key -N ""

          echo "ğŸ“ SSH key pair generated successfully"
          echo "Public key fingerprint: $(ssh-keygen -lf ~/.ssh/pronunciation-analysis-key.pub)"

          echo "PUBLIC_KEY=$(cat ~/.ssh/pronunciation-analysis-key.pub)" >> $GITHUB_ENV
          echo "PRIVATE_KEY<<EOF" >> $GITHUB_ENV
          cat ~/.ssh/pronunciation-analysis-key >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

          echo "âœ… SSH environment variables set"

      - name: Terraform Init
        run: terraform init
        working-directory: ./infrastructure

      - name: Check existing infrastructure
        id: check-infra
        run: |
          # Check if EC2 instance exists
          INSTANCE_ID=$(aws ec2 describe-instances \
            --filters "Name=tag:Name,Values=pronunciation-analysis-web-server" "Name=instance-state-name,Values=running,pending,stopping,stopped" \
            --query "Reservations[0].Instances[0].InstanceId" --output text)

          if [ "$INSTANCE_ID" != "None" ] && [ "$INSTANCE_ID" != "" ]; then
            echo "existing_instance=true" >> $GITHUB_OUTPUT
            echo "instance_id=$INSTANCE_ID" >> $GITHUB_OUTPUT
            echo "âœ… Found existing EC2 instance: $INSTANCE_ID"
            
            # Get the public IP
            PUBLIC_IP=$(aws ec2 describe-instances \
              --instance-ids $INSTANCE_ID \
              --query "Reservations[0].Instances[0].PublicIpAddress" --output text)
            echo "public_ip=$PUBLIC_IP" >> $GITHUB_OUTPUT
            echo "ğŸŒ Existing public IP: $PUBLIC_IP"
          else
            echo "existing_instance=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ No existing instance found, will create new infrastructure"
            
            # Clean up any orphaned resources only if no instance exists
            aws ec2 describe-key-pairs --query "KeyPairs[?starts_with(KeyName, 'pronunciation-analysis-deployer-key')].KeyName" --output text | \
            xargs -r -I {} aws ec2 delete-key-pair --key-name {} || true
            
            aws ec2 describe-security-groups \
              --filters "Name=group-name,Values=pronunciation-analysis-web-sg-*" \
              --query "SecurityGroups[].GroupId" --output text | \
            xargs -r -I {} aws ec2 delete-security-group --group-id {} || true
          fi

      - name: Terraform Plan
        if: steps.check-infra.outputs.existing_instance == 'false'
        run: terraform plan -out=tfplan -var="public_key=${{ env.PUBLIC_KEY }}"
        working-directory: ./infrastructure

      - name: Terraform Apply
        if: steps.check-infra.outputs.existing_instance == 'false'
        run: terraform apply -auto-approve tfplan
        working-directory: ./infrastructure

      - name: Get EC2 public IP
        id: get-ip
        run: |
          if [ "${{ steps.check-infra.outputs.existing_instance }}" == "true" ]; then
            echo "ec2_ip=${{ steps.check-infra.outputs.public_ip }}" >> $GITHUB_OUTPUT
            echo "ğŸŒ Using existing Static IP Address: ${{ steps.check-infra.outputs.public_ip }}"
            echo "ğŸ”— Application URL: http://${{ steps.check-infra.outputs.public_ip }}:3000"
            echo "ğŸ”— Application URL (via Nginx): http://${{ steps.check-infra.outputs.public_ip }}"
            echo "ğŸš€ API Endpoint: http://${{ steps.check-infra.outputs.public_ip }}:3000/api/pronunciation-assessment"
          else
            echo "ec2_ip=$(terraform output -raw ec2_public_ip)" >> $GITHUB_OUTPUT
            echo "ğŸŒ New Static IP Address: $(terraform output -raw ec2_public_ip)"
            echo "ğŸ”— Application URL: http://$(terraform output -raw ec2_public_ip):3000"
            echo "ğŸ”— Application URL (via Nginx): http://$(terraform output -raw ec2_public_ip)"
            echo "ğŸš€ API Endpoint: http://$(terraform output -raw ec2_public_ip):3000/api/pronunciation-assessment"
          fi
        working-directory: ./infrastructure

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Create source code package
        run: |
          mkdir -p deployment
          # Copy source files only (no build artifacts)
          cp -r app/ deployment/
          cp -r public/ deployment/
          cp package*.json deployment/
          cp next.config.js deployment/
          cp tsconfig.json deployment/
          cp tailwind.config.js deployment/
          cp postcss.config.js deployment/
          cp .eslintrc.json deployment/
                    # Copy environment example for reference
          cp env.example deployment/
          echo "ğŸ“¦ Source code package created (no build artifacts)"

      - name: Wait for EC2 instance to be ready
        run: |
          echo "â³ Waiting for EC2 instance to be ready..."

          # If it's a new instance, wait for it to be running
          if [ "${{ steps.check-infra.outputs.existing_instance }}" == "false" ]; then
            echo "ğŸ” Waiting for new instance to boot..."
            sleep 60  # Give new instance time to boot
          fi

          echo "âœ… Proceeding with deployment"

      - name: Deploy source code and build on EC2
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ steps.get-ip.outputs.ec2_ip }}
          username: ec2-user
          key: ${{ env.PRIVATE_KEY }}
          port: 22
          script: |
            echo "ğŸ§¹ Cleaning up existing application..."

            # Stop the running application
            pm2 delete pronunciation-analysis-demo || true

            # Clean up old application files
            if [ -d "/home/ec2-user/app" ]; then
              echo "ğŸ“‚ Removing old application files..."
              rm -rf /home/ec2-user/app/*
              rm -rf /home/ec2-user/app/.* 2>/dev/null || true
            else
              mkdir -p /home/ec2-user/app
            fi

            # Clean up npm cache to free space
            echo "ğŸ§¹ Cleaning npm cache..."
            npm cache clean --force 2>/dev/null || true

            echo "âœ… Cleanup completed, application directory is clean"

            # Show disk usage after cleanup
            echo "ğŸ’¾ Disk usage after cleanup:"
            df -h /
            echo ""
            echo "ğŸš€ Setting up application environment..."

            cd /home/ec2-user/app

            # Install Node.js if not present
            if ! command -v node &> /dev/null; then
              echo "ğŸ“¦ Installing Node.js 18..."
              curl -fsSL https://rpm.nodesource.com/setup_18.x | sudo bash -
              sudo dnf install -y nodejs
              echo "âœ… Node.js installed: $(node --version)"
            else
              echo "âœ… Node.js already installed: $(node --version)"
            fi

            # Install PM2 if not present
            if ! command -v pm2 &> /dev/null; then
              echo "ğŸ“¦ Installing PM2..."
              sudo npm install -g pm2
              echo "âœ… PM2 installed: $(pm2 --version)"
            else
              echo "âœ… PM2 already installed: $(pm2 --version)"
            fi

      - name: Transfer source files via rsync
        run: |
          echo "ğŸ“¤ Transferring source code to EC2..."

          # Create SSH key file
          echo "${{ env.PRIVATE_KEY }}" > /tmp/ssh_key
          chmod 600 /tmp/ssh_key

          # Transfer files using rsync (much more efficient than scp)
          rsync -avz --delete \
            -e "ssh -i /tmp/ssh_key -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null" \
            deployment/ \
            ec2-user@${{ steps.get-ip.outputs.ec2_ip }}:/home/ec2-user/app/

          echo "âœ… Source code transferred successfully"

          # Clean up SSH key
          rm -f /tmp/ssh_key

      - name: Build and start application on EC2
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ steps.get-ip.outputs.ec2_ip }}
          username: ec2-user
          key: ${{ env.PRIVATE_KEY }}
          port: 22
          script: |
            cd /home/ec2-user/app

            echo "ğŸš€ Building and starting application..."

            # Install dependencies and build application
            if [ -f "package.json" ]; then
              echo "ğŸ“¦ Installing dependencies..."
              npm ci
              echo "âœ… Dependencies installed"
              
              # Show disk usage after dependencies
              echo "ğŸ’¾ Disk usage after dependencies:"
              df -h /
              
              echo "ğŸ”¨ Building application..."
              npm run build
              echo "âœ… Application built successfully"
              
              # Show disk usage after build
              echo "ğŸ’¾ Disk usage after build:"
              df -h /
              
              # Clean up dev dependencies to save space
              echo "ğŸ§¹ Cleaning up dev dependencies..."
              npm prune --production
              echo "âœ… Dev dependencies removed"
              
              # Final disk usage
              echo "ğŸ’¾ Final disk usage:"
              df -h /
            fi

            # Start the application with PM2
            echo "ğŸ”„ Starting application with PM2..."
            pm2 start npm --name "pronunciation-analysis-demo" -- start
            pm2 save
            pm2 startup

            echo "âœ… Application started successfully!"
            echo ""
            echo "ğŸ“Š Application Status:"
            pm2 list
            echo ""
            echo "ğŸ”— Application should be available at the URLs shown below"

      - name: Display Deployment Information
        run: |
          if [ "${{ steps.check-infra.outputs.existing_instance }}" == "true" ]; then
            echo "ğŸ”„ Application update completed successfully!"
            echo "â™»ï¸ Reused existing EC2 instance: ${{ steps.check-infra.outputs.instance_id }}"
          else
            echo "ğŸ‰ New deployment completed successfully!"
            echo "ğŸ†• Created new infrastructure"
          fi
          echo ""
          echo "ğŸ“ DEPLOYMENT INFORMATION:"
          echo "========================="
          echo "ğŸŒ Static IP Address: ${{ steps.get-ip.outputs.ec2_ip }}"
          echo "ğŸ”— Application URL (Direct): http://${{ steps.get-ip.outputs.ec2_ip }}:3000"
          echo "ğŸ”— Application URL (Nginx): http://${{ steps.get-ip.outputs.ec2_ip }}"
          echo "ğŸš€ API Endpoint: http://${{ steps.get-ip.outputs.ec2_ip }}:3000/api/pronunciation-assessment"
          echo ""
          echo "ğŸ“ Additional Information:"
          echo "- SSH Access: ssh -i your-key.pem ec2-user@${{ steps.get-ip.outputs.ec2_ip }}"
          echo "- PM2 Status: ssh -i your-key.pem ec2-user@${{ steps.get-ip.outputs.ec2_ip }} 'pm2 list'"
          echo "- Application Logs: ssh -i your-key.pem ec2-user@${{ steps.get-ip.outputs.ec2_ip }} 'pm2 logs pronunciation-analysis-demo'"
